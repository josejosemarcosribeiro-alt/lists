extends layout

block content
    br
    h3 Add Aula

    form(method="POST", action="/list/add", enctype="multipart/form-data")
        #form-group
            label Title:
            input.form-control(name="title", type="text", required)

        #form-group
            label Upload Aula (optional):
            input(type="hidden", name="video", id="videoInput")
            button.btn.btn-secondary(type="button", id="uploadButton") Upload VÃ­deo
            button.btn.btn-danger(type="button", id="deleteVideoButton", style="display:none; margin-left:10px;") Delete Video

        #form-group
            label Description (optional):
            textarea.form-control(name="body", rows="3", placeholder="Add a short description about your aula")

        br
        input.btn.btn-primary.float-right(type="submit", value="Submit")

    if errors
        ul.text-danger
            each err in errors
                li= err.msg
    if success
        p.text-success= success

    script(src="https://upload-widget.cloudinary.com/latest/global/all.js")
    script.
        const myWidget = cloudinary.createUploadWidget({
            cloudName: '!{cloudName}',       // Vem do backend
            uploadPreset: '!{uploadPreset}', // Vem do backend
            multiple: false,
            resourceType: 'video',
            clientAllowedFormats: ['mp4', 'mov', 'avi']
        }, (error, result) => {
            if (!error && result && result.event === "success") {
                console.log('Upload realizado:', result.info.secure_url);
                const videoInput = document.getElementById('videoInput');
                videoInput.value = result.info.secure_url;
                document.getElementById('deleteVideoButton').style.display = 'inline-block';
            }
        });

        document.getElementById("uploadButton").addEventListener("click", () => {
            myWidget.open();
        });

        document.getElementById("deleteVideoButton").addEventListener("click", async () => {
            const videoInput = document.getElementById('videoInput');
            if(!videoInput.value) return;

            try {
                const response = await fetch('/delete-video/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoUrl: videoInput.value })
                });

                if(response.ok){
                    videoInput.value = '';
                    document.getElementById('deleteVideoButton').style.display = 'none';
                    console.log('Video deleted from Cloudinary and backend');
                } else {
                    console.error('Failed to delete video');
                }
            } catch(err){
                console.error('Error deleting video:', err);
            }
        });
